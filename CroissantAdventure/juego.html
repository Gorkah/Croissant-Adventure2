<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Croissant Adventure - El Mundo de Migalandia</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffe9c7;
            color: #5c4a38;
        }
        #header {
            background-color: #ff9900;
            color: white;
            text-align: center;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #game-container {
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            position: relative;
        }
        #intro {
            text-align: center;
            margin: 30px auto;
            max-width: 800px;
            padding: 20px;
            background-color: #fff8e6;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(210, 156, 76, 0.15);
        }
        .back-button {
            display: inline-block;
            margin: 20px 0;
            padding: 10px 20px;
            background-color: #ff9900;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .back-button:hover {
            background-color: #e68a00;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        #game-info {
            margin: 20px;
            padding: 15px;
            background-color: #fffbf2;
            border-radius: 10px;
            border-left: 5px solid #ff9900;
        }
        #welcome-title {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #ff9900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .game-icon {
            font-size: 2em;
            margin-right: 10px;
            vertical-align: middle;
        }
        .game-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }
        .game-button {
            display: inline-block;
            padding: 10px 15px;
            background-color: #ff9900;
            color: white;
            border-radius: 20px;
            text-decoration: none;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .game-button:hover {
            background-color: #e68a00;
            transform: translateY(-2px);
        }
        #instructions {
            margin-top: 30px;
            padding: 15px;
            background-color: #fff3d4;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Croissant Adventure</h1>
        <p>¬°Explora el m√°gico mundo de Migalandia con Croissi el croissant!</p>
    </div>

    <div id="intro">
        <div id="game-prompt">
            <h2 id="welcome-title">¬°Bienvenido a Migalandia!</h2>
            <p>Habla con Croissi, nuestro gu√≠a m√°gico, para que te recomiende aventuras seg√∫n tus gustos.</p>
            <p>Croissi te contar√° una historia y te ayudar√° a encontrar el juego perfecto para ti.</p>
            
            <div id="instructions">
                <h3>¬øC√≥mo funciona?</h3>
                <p>1. Haz clic en el √≠cono del chat en la esquina inferior derecha</p>
                <p>2. Cu√©ntale a Croissi qu√© tipo de aventura te gustar√≠a vivir</p>
                <p>3. Croissi te recomendar√° uno o varios juegos que te podr√≠an gustar</p>
                <p>4. ¬°Haz clic en el bot√≥n del juego recomendado para comenzar a jugar!</p>
            </div>
            
            <div class="game-buttons">
                <a href="juego.html?game=coinCollector" class="game-button">ü™ô El Tesoro del Valle Dorado</a>
                <a href="juego.html?game=roulette" class="game-button">üé∞ La Rueda de la Fortuna</a>
                <a href="juego.html?game=chess" class="game-button">‚ôû El Reino Cuadriculado</a>
                <a href="juego.html?game=maze" class="game-button">üß© El Bosque Enredado</a>
                <a href="juego.html?game=shooter" class="game-button">üî´ El Cielo Azucarado</a>
                <a href="juego.html?game=platform" class="game-button">üèÉ Islas Flotantes</a>
                <a href="juego.html?game=memory" class="game-button">üÉè Las Cartas Gemelas</a>
                <a href="juego.html?game=snake" class="game-button">üêç Silbi la Serpiente</a>
                <a href="juego.html?game=puzzle" class="game-button">üß† El Cuadro M√°gico</a>
                <a href="juego.html?game=rhythm" class="game-button">üéµ La Orquesta Dulce</a>
                <a href="juego.html?game=towerDefense" class="game-button">üè∞ El Castillo de Az√∫car</a>
            </div>
        </div>
        
        <div id="game-info" style="display: none;">
            <!-- Contenido din√°mico seg√∫n el juego seleccionado -->
        </div>
    </div>

    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div style="text-align: center;">
            <a href="juego.html" class="back-button" id="back-button" style="display: none;">Volver a Migalandia</a>
        </div>
    </div>

    <!-- Core Game Engine -->
    <script src="js/game.js"></script>
    
    <!-- Scenes -->
    <script src="js/scenes/scene.js"></script>
    <script src="js/scenes/mainMenu.js"></script>
    <script src="js/scenes/worldMap_simple.js"></script>
    
    <!-- Minigames -->
    <script src="js/minigames/minigame.js"></script>
    <script src="js/minigames/coinCollector.js"></script>
    <script src="js/minigames/roulette.js"></script>
    <script src="js/minigames/chess.js"></script>
    <script src="js/minigames/maze.js"></script>
    <script src="js/minigames/shooter.js"></script>
    
    <!-- Nuevos Minijuegos -->
    <script src="js/minigames/platform.js"></script>
    <script src="js/minigames/memory.js"></script>
    <script src="js/minigames/snake.js"></script>
    <script src="js/minigames/puzzle.js"></script>
    <script src="js/minigames/rhythm.js"></script>
    <script src="js/minigames/towerDefense.js"></script>
    
    <!-- Estilos del chat personalizado -->
    <link rel="stylesheet" href="css/ai-chat.css">
    
    <!-- Scripts del chat personalizado -->
    <script src="js/ai/storytellerAI.js"></script>
    <script src="js/ai/chatInterface.js"></script>
    
    <!-- Contenedor del chat -->
    <div id="chat-container" class="custom-chat-container"></div>
    
    <!-- Sistema de gesti√≥n de personajes -->
    <script>
        // Objeto global para gestionar el personaje del jugador
        window.playerCharacter = {
            // Por defecto es croiso
            character: 'croiso',
            
            // Inicializar el personaje seg√∫n lo seleccionado en el login
            initialize: function() {
                // Obtener el personaje de los par√°metros URL o localStorage
                const urlParams = new URLSearchParams(window.location.search);
                const paramCharacter = urlParams.get('character');
                const storedCharacter = localStorage.getItem('selectedCharacter');
                
                // Priorizar el par√°metro URL, luego localStorage, sino usar el valor por defecto
                if (paramCharacter) {
                    this.character = paramCharacter;
                } else if (storedCharacter) {
                    this.character = storedCharacter;
                }
                
                console.log('Personaje inicializado:', this.character);
                
                // Aplicar el personaje a los elementos de la interfaz
                this.applyCharacterToUI();
                
                return this.character;
            },
            
            // Aplicar el personaje a los elementos de la interfaz
            applyCharacterToUI: function() {
                // Cambiar referencias visuales seg√∫n el personaje
                document.querySelectorAll('.player-character-img').forEach(element => {
                    element.src = this.character + '.png';
                });
                
                // Cambiar referencias de texto seg√∫n el personaje
                const characterDisplayName = this.character === 'croiso' ? 'Croiso' : 'Croisa';
                document.querySelectorAll('.player-character-name').forEach(element => {
                    element.textContent = characterDisplayName;
                });
                
                console.log('Personaje aplicado a la interfaz:', characterDisplayName);
            },
            
            // Obtener la imagen del personaje
            getImage: function() {
                return this.character + '.png';
            },
            
            // Obtener el nombre de visualizaci√≥n del personaje
            getDisplayName: function() {
                return this.character === 'croiso' ? 'Croiso' : 'Croisa';
            }
        };
    </script>
    
    <!-- Script para inicializar el chat y detectar menciones de juegos en los mensajes -->
    <script>
        // Variables globales
        let chatInterface = null;
        
        // Funci√≥n para procesar menciones de juegos en un mensaje
        function processGameMentions(messageElement) {
            const messageText = messageElement.textContent;
            const gamePatterns = [
                // Versi√≥n completa
                { name: "El Tesoro del Valle Dorado", game: "coinCollector", emoji: "ü™ô" },
                { name: "La Rueda de la Fortuna M√°gica", game: "roulette", emoji: "üé∞" },
                { name: "Los Guardianes del Reino Cuadriculado", game: "chess", emoji: "‚ôû" },
                { name: "El Bosque Enredado de Migalandia", game: "maze", emoji: "üß©" },
                { name: "Los Burbujeadores del Cielo Azucarado", game: "shooter", emoji: "üî´" },
                { name: "Las Islas Flotantes de Bizcocho", game: "platform", emoji: "üèÉ" },
                { name: "El Misterio de las Cartas Gemelas", game: "memory", emoji: "üÉè" },
                { name: "Las Aventuras de Silbi la Serpiente Golosa", game: "snake", emoji: "üêç" },
                { name: "El Cuadro M√°gico Despiezado", game: "puzzle", emoji: "üß†" },
                { name: "La Orquesta Dulce de Migalandia", game: "rhythm", emoji: "üéµ" },
                { name: "Los Guardianes del Castillo de Az√∫car", game: "towerDefense", emoji: "üè∞" },
                
                // Versi√≥n corta para detectar menciones parciales
                { name: "Valle Dorado", game: "coinCollector", emoji: "ü™ô" },
                { name: "Tesoro", game: "coinCollector", emoji: "ü™ô" },
                { name: "monedas", game: "coinCollector", emoji: "ü™ô" },
                { name: "Fortuna", game: "roulette", emoji: "üé∞" },
                { name: "Ruleta", game: "roulette", emoji: "üé∞" },
                { name: "Rueda", game: "roulette", emoji: "üé∞" },
                { name: "Ajedrez", game: "chess", emoji: "‚ôû" },
                { name: "Reino Cuadriculado", game: "chess", emoji: "‚ôû" },
                { name: "Laberinto", game: "maze", emoji: "üß©" },
                { name: "Bosque Enredado", game: "maze", emoji: "üß©" },
                { name: "Disparos", game: "shooter", emoji: "üî´" },
                { name: "burbujas", game: "shooter", emoji: "üî´" },
                { name: "Cielo Azucarado", game: "shooter", emoji: "üî´" },
                { name: "Plataformas", game: "platform", emoji: "üèÉ" },
                { name: "saltar", game: "platform", emoji: "üèÉ" },
                { name: "Islas Flotantes", game: "platform", emoji: "üèÉ" },
                { name: "Memoria", game: "memory", emoji: "üÉè" },
                { name: "Cartas Gemelas", game: "memory", emoji: "üÉè" },
                { name: "Serpiente", game: "snake", emoji: "üêç" },
                { name: "Silbi", game: "snake", emoji: "üêç" },
                { name: "Puzzle", game: "puzzle", emoji: "üß†" },
                { name: "Rompecabezas", game: "puzzle", emoji: "üß†" },
                { name: "Cuadro M√°gico", game: "puzzle", emoji: "üß†" },
                { name: "Ritmo", game: "rhythm", emoji: "üéµ" },
                { name: "m√∫sica", game: "rhythm", emoji: "üéµ" },
                { name: "melod√≠a", game: "rhythm", emoji: "üéµ" },
                { name: "Orquesta", game: "rhythm", emoji: "üéµ" },
                { name: "Torres", game: "towerDefense", emoji: "üè∞" },
                { name: "Castillo", game: "towerDefense", emoji: "üè∞" },
                { name: "defensa", game: "towerDefense", emoji: "üè∞" }
            ];

            // Verificar si el mensaje menciona alguno de los juegos
            let mentionedGames = [];
            let html = messageElement.innerHTML;
            
            // Crear un mapa para eliminar duplicados
            const uniqueGames = new Map();

            gamePatterns.forEach(pattern => {
                // Hacer la b√∫squeda case-insensitive
                const regex = new RegExp(pattern.name, 'gi');
                if (regex.test(messageText)) {
                    // Agregar juego al mapa usando la ID del juego como clave
                    uniqueGames.set(pattern.game, pattern);
                }
            });
            
            // Convertir el mapa en array
            mentionedGames = Array.from(uniqueGames.values());

            // Si se mencionan juegos, a√±adir botones de juego al final del mensaje
            if (mentionedGames.length > 0) {
                let gameButtons = '<div class="game-buttons">';
                mentionedGames.forEach(game => {
                    gameButtons += `<a href="juego.html?game=${game.game}" class="game-button">${game.emoji} Jugar a ${game.name}</a>`;
                });
                gameButtons += '</div>';
                html += gameButtons;
                messageElement.innerHTML = html;
            }
        }

        // Inicializar el chat personalizado con Trash y el personaje seleccionado
        function initializeCustomChat() {
            console.log("Inicializando chat personalizado con el personaje seleccionado...");
            
            // Crear instancia del chat si no existe a√∫n
            if (!chatInterface) {
                chatInterface = new ChatInterface();
            }
            
            // Inicializar la interfaz
            chatInterface.initialize().then(() => {
                console.log("Chat personalizado inicializado correctamente");
                
                // Configurar detecci√≥n de menciones de juegos
                setupGameMentionsDetection();
                
                // Aplicar el personaje seleccionado a los mensajes del chat
                applyPlayerCharacterToChat();
            }).catch(error => {
                console.error("Error al inicializar el chat personalizado:", error);
            });
        }
        
        // Funci√≥n para aplicar el personaje seleccionado a los mensajes del chat
        function applyPlayerCharacterToChat() {
            // Aplicar estilos din√°micos para los mensajes del usuario (con la imagen del personaje seleccionado)
            const characterImage = window.playerCharacter.getImage();
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                .message.user::after {
                    background-image: url('${characterImage}');
                }
            `;
            document.head.appendChild(styleElement);
            
            // Configurar un observador para aplicar el estilo a los nuevos mensajes
            const chatObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                        // Actualizar referencias al personaje en el texto (si es necesario)
                        const characterName = window.playerCharacter.getDisplayName();
                        document.querySelectorAll('.player-character-name').forEach(element => {
                            element.textContent = characterName;
                        });
                    }
                });
            });
            
            // Observar cambios en el contenedor de mensajes
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatObserver.observe(chatMessages, { childList: true, subtree: true });
            }
        }
        
        // Configurar detecci√≥n de menciones de juegos en el chat personalizado
        function setupGameMentionsDetection() {
            // Obtener el contenedor de mensajes
            const chatMessages = document.getElementById('chat-messages');
            
            if (!chatMessages) {
                console.error("No se encontr√≥ el contenedor de mensajes del chat");
                return;
            }
            
            // Usar MutationObserver para detectar nuevos mensajes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                        // Procesar √∫nicamente los nuevos mensajes de la IA
                        mutation.addedNodes.forEach(node => {
                            if (node.classList && node.classList.contains('message') && 
                                node.classList.contains('assistant') && 
                                !node.dataset.processed) {
                                
                                console.log("Nuevo mensaje del asistente detectado:", node.textContent);
                                processGameMentions(node);
                                node.dataset.processed = 'true';
                            }
                        });
                    }
                });
            });
            
            // Comenzar a observar cambios en el contenedor de mensajes
            observer.observe(chatMessages, { childList: true, subtree: true });
        }
        
        // Inicializar el chat cuando la p√°gina est√© cargada
        window.addEventListener('load', function() {
            console.log("P√°gina cargada. Inicializando chat personalizado...");
            setTimeout(initializeCustomChat, 1000);
        });
        
        // Crear un bot√≥n flotante para abrir el chat
        function createChatButton() {
            const button = document.createElement('button');
            button.id = 'chat-toggle-button';
            button.className = 'chat-toggle-button';
            button.innerHTML = 'üí¨';
            button.title = 'Hablar con Trash';
            
            // Estilos para el bot√≥n
            button.style.position = 'fixed';
            button.style.bottom = '20px';
            button.style.right = '20px';
            button.style.width = '60px';
            button.style.height = '60px';
            button.style.borderRadius = '50%';
            button.style.backgroundColor = '#ff9900';
            button.style.color = 'white';
            button.style.border = 'none';
            button.style.fontSize = '24px';
            button.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
            button.style.cursor = 'pointer';
            button.style.zIndex = '1000';
            button.style.transition = 'all 0.3s ease';
            
            // Comportamiento de hover
            button.onmouseover = function() {
                this.style.transform = 'scale(1.1)';
            };
            button.onmouseout = function() {
                this.style.transform = 'scale(1)';
            };
            
            // Agregar al cuerpo del documento
            document.body.appendChild(button);
            
            // Mostrar/ocultar el chat al hacer clic en el bot√≥n
            button.addEventListener('click', function() {
                const chatContainer = document.getElementById('chat-container');
                if (chatContainer.style.display === 'none' || !chatContainer.style.display) {
                    chatContainer.style.display = 'block';
                    // Inicializar el chat si a√∫n no se ha hecho
                    if (!chatInterface || !chatInterface.initialized) {
                        initializeCustomChat();
                    }
                } else {
                    chatContainer.style.display = 'none';
                }
            });
            
            // Estilos para el contenedor del chat
            const chatContainer = document.getElementById('chat-container');
            chatContainer.style.position = 'fixed';
            chatContainer.style.bottom = '90px';
            chatContainer.style.right = '20px';
            chatContainer.style.width = '350px';
            chatContainer.style.height = '500px';
            chatContainer.style.zIndex = '999';
            chatContainer.style.display = 'none';
            chatContainer.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.3)';
            chatContainer.style.borderRadius = '10px';
            chatContainer.style.overflow = 'hidden';
        }
        
        // Crear el bot√≥n de chat cuando el DOM est√© cargado
        document.addEventListener('DOMContentLoaded', createChatButton);
    </script>
    
    <!-- Initialize Game -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar el sistema de personajes
            window.playerCharacter.initialize();
            
            // Obtener el par√°metro 'game' de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const gameParam = urlParams.get('game');
            
            const gameInfoElement = document.getElementById('game-info');
            const gamePromptElement = document.getElementById('game-prompt');
            const backButton = document.getElementById('back-button');
            
            // Informaci√≥n de los juegos
            const games = {
                coinCollector: {
                    name: "El Tesoro del Valle Dorado",
                    icon: "ü™ô",
                    description: "Recoge las monedas doradas antes de que se acabe el tiempo en este m√°gico valle."
                },
                roulette: {
                    name: "La Rueda de la Fortuna M√°gica",
                    icon: "üé∞",
                    description: "Gira la rueda y prueba tu suerte en la Ciudad de los Deseos."
                },
                chess: {
                    name: "Los Guardianes del Reino Cuadriculado",
                    icon: "‚ôû",
                    description: "Planifica tus movimientos estrat√©gicos en el Reino Cuadriculado."
                },
                maze: {
                    name: "El Bosque Enredado de Migalandia",
                    icon: "üß©",
                    description: "Encuentra el camino a trav√©s del misterioso Bosque Enredado."
                },
                shooter: {
                    name: "Los Burbujeadores del Cielo Azucarado",
                    icon: "üî´",
                    description: "Revienta las burbujas m√°gicas en el colorido Cielo Azucarado."
                },
                platform: {
                    name: "Las Islas Flotantes de Bizcocho",
                    icon: "üèÉ",
                    description: "Salta entre las plataformas flotantes y recoge estrellas fugaces."
                },
                memory: {
                    name: "El Misterio de las Cartas Gemelas",
                    icon: "üÉè",
                    description: "Encuentra los pares coincidentes en la Villa de los Recuerdos."
                },
                snake: {
                    name: "Las Aventuras de Silbi la Serpiente Golosa",
                    icon: "üêç",
                    description: "Ayuda a Silbi a recoger manzanas m√°gicas sin tropezar con su cola."
                },
                puzzle: {
                    name: "El Cuadro M√°gico Despiezado",
                    icon: "üß†",
                    description: "Desliza las piezas para completar las im√°genes m√°gicas de la Galer√≠a."
                },
                rhythm: {
                    name: "La Orquesta Dulce de Migalandia",
                    icon: "üéµ",
                    description: "Sigue el ritmo de las notas musicales en el Valle de la Melod√≠a."
                },
                towerDefense: {
                    name: "Los Guardianes del Castillo de Az√∫car",
                    icon: "üè∞",
                    description: "Construye torres para defender el Castillo Glaseado de los invasores."
                }
            };
            
            // Si hay un juego especificado en la URL
            if (gameParam && games[gameParam]) {
                const game = games[gameParam];
                
                // Mostrar informaci√≥n del juego
                gameInfoElement.innerHTML = `
                    <h3><span class="game-icon">${game.icon}</span> ${game.name}</h3>
                    <p>${game.description}</p>
                `;
                
                gameInfoElement.style.display = 'block';
                gamePromptElement.style.display = 'none';
                backButton.style.display = 'inline-block';
                
                // Inicializar el juego
                window.addEventListener('load', () => {
                    const gameInstance = new Game();
                    gameInstance.start();
                    
                    // Cambiar directamente a la escena del juego seleccionado
                    setTimeout(() => {
                        if (gameInstance.scenes[gameParam]) {
                            gameInstance.switchScene(gameParam);
                        } else {
                            console.error(`No se encontr√≥ la escena para el juego: ${gameParam}`);
                        }
                    }, 500);
                });
            } else {
                // Si no hay juego especificado, mostrar la pantalla de inicio
                gamePromptElement.style.display = 'block';
                gameInfoElement.style.display = 'none';
                
                // Inicializar el juego en modo mapa del mundo
                window.addEventListener('load', () => {
                    const game = new Game();
                    game.start();
                    setTimeout(() => {
                        if (game.scenes['worldMap']) {
                            game.switchScene('worldMap');
                        }
                    }, 500);
                });
            }
        });
    </script>
</body>
</html>
